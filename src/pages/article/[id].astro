---
import Layout from "../../layouts/Layout.astro";
import ArticleTabs from "../../components/ArticleTabs";
import WordSidebar from "../../components/WordSidebar";
import AudioPlayer from "../../components/AudioPlayer";
import { and, eq, isNotNull } from "drizzle-orm";
import { articles, tasks } from "../../../db/schema";
import { getDb } from "../../lib/db";
import { isAdminRequest } from "../../lib/admin";

const id = Astro.params.id;
if (!id) Astro.response.status = 404;

const db = getDb(Astro.locals);
const rows = id
	? await db
			.select()
			.from(articles)
			.innerJoin(tasks, eq(articles.generationTaskId, tasks.id))
			.where(
				and(
					eq(articles.id, id),
					eq(articles.status, "published"),
					isNotNull(tasks.publishedAt),
				),
			)
			.limit(1)
	: [];

const row = rows[0] ?? null;
if (!row) Astro.response.status = 404;

const isAdmin = isAdminRequest(Astro.request, Astro.locals);

let parsed: any = null;
if (row) {
	try {
		parsed = JSON.parse(row.articles.contentJson);
	} catch {
		throw new Error("Invalid content_json: JSON parse failed");
	}
}

if (
	!Array.isArray(parsed?.result?.sources) ||
	!parsed.result.sources.every((s: unknown) => typeof s === "string")
) {
	throw new Error("Invalid content_json: sources must be string[]");
}
const sources: string[] = parsed.result.sources;

// 从 LLM 输出中提取 word_definitions
const wordDefinitions: Array<{
	word: string;
	phonetic: string;
	definitions: { pos: string; definition: string }[];
}> = (() => {
	const defs = parsed?.result?.word_definitions;
	if (!Array.isArray(defs)) {
		throw new Error("Invalid content_json: word_definitions must be array");
	}
	return defs;
})();

// 构建侧栏展示所需词汇数据
const sidebarWords = wordDefinitions.map((w) => ({
	word: w.word,
	phonetic: w.phonetic || "",
	definitions: w.definitions || [],
}));

const weekdayNames = [
	"Sunday",
	"Monday",
	"Tuesday",
	"Wednesday",
	"Thursday",
	"Friday",
	"Saturday",
];

function formatDateLabel(value?: string | null) {
	if (!value) return "";
	const iso = value.includes("T") ? value : `${value}T00:00:00`;
	const date = new Date(iso);
	if (Number.isNaN(date.getTime())) return value;
	const weekday = weekdayNames[date.getDay()] ?? "";
	const yyyy = String(date.getFullYear());
	const mm = String(date.getMonth() + 1).padStart(2, "0");
	const dd = String(date.getDate()).padStart(2, "0");
	return weekday ? `${weekday}, ${yyyy}/${mm}/${dd}` : `${yyyy}/${mm}/${dd}`;
}

const dateLabel = row ? formatDateLabel(row.tasks.taskDate) : "";
const sourceAnchorId = sources.length > 0 ? "article-sources" : null;
---

<Layout
	title={row?.articles?.title ?? `Article ${id ?? ""}`}
	mainClass="mx-auto w-full max-w-7xl px-4 py-10"
>
	{
		row ? (
			<div class="flex flex-col lg:flex-row gap-10">
				{/* Main Content */}
				<main
					class={`flex-1 min-w-0 ${sidebarWords.length === 0 ? "max-w-3xl mx-auto" : ""}`}
				>
					<div class="space-y-8">
						{parsed?.result?.articles ? (
							<ArticleTabs
								client:load
								articleId={row.articles.id}
								articles={parsed.result.articles}
								initialIsAdmin={isAdmin}
								title={row.articles.title}
								dateLabel={dateLabel}
								sourceAnchorId={sourceAnchorId}
								targetWords={sidebarWords.map((w) => w.word)}
							/>
						) : (
							<div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
								内容解析失败（content_json 非预期结构）。
							</div>
						)}

						{sources.length > 0 ? (
							<div
								id={sourceAnchorId ?? undefined}
								class="pt-8 mt-8 border-t border-slate-900/10"
							>
								<div class="text-[10px] font-bold uppercase tracking-widest text-stone-500 mb-4">
									Sources
								</div>
								<ul class="space-y-1">
									{sources.map((u) => {
										let domain = u;
										try {
											domain = new URL(
												u,
											).hostname.replace(/^www\./, "");
										} catch {}
										return (
											<li class="flex items-center gap-2">
												<span class="w-1 h-1 rounded-full bg-stone-300" />
												<a
													href={u}
													target="_blank"
													rel="noreferrer"
													class="text-xs font-serif text-stone-500 hover:text-slate-900 underline decoration-stone-300 underline-offset-4 hover:decoration-slate-900 transition-all"
													title={u}
												>
													{domain}
												</a>
											</li>
										);
									})}
								</ul>
							</div>
						) : null}
					</div>
				</main>

				{/* Sidebar - Words */}
				{sidebarWords.length > 0 && (
					<aside class="lg:w-80 lg:shrink-0">
						<div class="lg:sticky lg:top-6 space-y-6">
							<AudioPlayer client:only="react" />
							<WordSidebar client:load words={sidebarWords} />
						</div>
					</aside>
				)}
			</div>
		) : (
			<div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
				该文章不存在或未发布。
			</div>
		)
	}
</Layout>
