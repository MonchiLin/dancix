---
import Layout from "../../layouts/Layout.astro";
import ArticleTabs from "../../components/ArticleTabs";
import ArticleContent from "../../components/ArticleContent.astro";
import ArticleHeader from "../../components/ArticleHeader.astro";
import WordSidebar from "../../components/WordSidebar";
import AudioPlayer from "../../components/AudioPlayer";
import { getDb } from "../../lib/db";
import { isAdminRequest } from "../../lib/admin";
import {
	getArticleWithDetails,
} from "../../lib/articles/service";
import {
	extractSources,
	extractWordDefinitions,
	formatDateLabel,
	mapToSidebarWords,
	parseArticleContent,
	getInitialArticleData,
} from "../../lib/articles/utils";
import type { ArticleParsedContent } from "../../lib/articles/types";

const id = Astro.params.id;
if (!id) Astro.response.status = 404;

const db = getDb(Astro.locals);
const row = id ? await getArticleWithDetails(db, id) : null;
if (!row) Astro.response.status = 404;

const isAdmin = isAdminRequest(Astro.request, Astro.locals);

let parsed: ArticleParsedContent = {};
if (row) {
	try {
		parsed = parseArticleContent(row.articles.contentJson);
	} catch (e) {
		throw e;
	}
}

const sources = parsed?.result ? extractSources(parsed) : [];
const wordDefinitions = parsed?.result ? extractWordDefinitions(parsed) : [];
const sidebarWords = mapToSidebarWords(wordDefinitions);
const initialData = parsed ? getInitialArticleData(parsed) : null;

const dateLabel = row ? formatDateLabel(row.tasks.taskDate) : "";
const sourceAnchorId = sources.length > 0 ? "article-sources" : null;
---

<Layout
	title={row?.articles?.title ?? `Article ${id ?? ""}`}
	mainClass="mx-auto w-full max-w-7xl px-4 py-10"
>
	{
		row ? (
			<div class="flex flex-col lg:flex-row gap-10">
				{/* Main Content */}
				<main
					class={`flex-1 min-w-0 ${sidebarWords.length === 0 ? "max-w-3xl mx-auto" : ""}`}
				>
					<div class="space-y-8">
						{parsed?.result?.articles ? (
							<ArticleTabs
								client:only="react"
								articleId={row.articles.id}
								articles={parsed!.result!.articles!}
								initialIsAdmin={isAdmin}
								title={row.articles.title}
								dateLabel={dateLabel}
								sourceAnchorId={sourceAnchorId}
								targetWords={sidebarWords.map((w) => w.word)}
							>
								{initialData && (
									<div class="relative">
										<div class="bg-white rounded-3xl border border-gray-100 p-6 md:p-8">
											<ArticleHeader
												title={row.articles.title || ""}
												publishDate={dateLabel || ""}
												stats={{
													readCount: 0,
													readingTime:
														initialData.readingTime,
												}}
											/>
											<ArticleContent
												content={initialData.content}
											/>
										</div>
									</div>
								)}
							</ArticleTabs>
						) : (
							<div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
								内容解析失败（content_json 非预期结构）。
							</div>
						)}

						{sources.length > 0 ? (
							<div
								id={sourceAnchorId ?? undefined}
								class="pt-8 mt-8 border-t border-slate-900/10"
							>
								<div class="text-[10px] font-bold uppercase tracking-widest text-stone-500 mb-4">
									Sources
								</div>
								<ul class="space-y-1">
									{sources.map((u) => {
										let domain = u;
										try {
											domain = new URL(
												u,
											).hostname.replace(/^www\./, "");
										} catch {}
										return (
											<li class="flex items-center gap-2">
												<span class="w-1 h-1 rounded-full bg-stone-300" />
												<a
													href={u}
													target="_blank"
													rel="noreferrer"
													class="text-xs font-serif text-stone-500 hover:text-slate-900 underline decoration-stone-300 underline-offset-4 hover:decoration-slate-900 transition-all"
													title={u}
												>
													{domain}
												</a>
											</li>
										);
									})}
								</ul>
							</div>
						) : null}
					</div>
				</main>

				{/* Sidebar - Words */}
				{sidebarWords.length > 0 && (
					<aside class="lg:w-80 lg:shrink-0">
						<div class="lg:sticky lg:top-6 space-y-6">
							<AudioPlayer client:only="react" />
							<WordSidebar client:load words={sidebarWords} />
						</div>
					</aside>
				)}
			</div>
		) : (
			<div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
				该文章不存在或未发布。
			</div>
		)
	}
</Layout>
